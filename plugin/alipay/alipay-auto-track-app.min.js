var global={};const forEach=Array.prototype.forEach,slice=Array.prototype.slice,_hasOwnProperty=Object.prototype.hasOwnProperty,_toString=Object.prototype.toString;function extend(e){return each(slice.call(arguments,1),function(n){for(var o in n)void 0!==n[o]&&(e[o]=n[o])}),e}function isObject(e){return null!==e&&'object'==typeof e}function isFunction(e){if(!e)return!1;var n=Object.prototype.toString.call(e);return'[object Function]'==n||'[object AsyncFunction]'==n||'[object GeneratorFunction]'==n}function isString(e){return'[object String]'==_toString.call(e)}function each(e,n,o){if(null==e)return!1;if(forEach&&e.forEach===forEach)e.forEach(n,o);else if(e.length===+e.length){for(var t=0,r=e.length;t<r;t++)if(t in e&&n.call(o,e[t],t,e)==={})return!1}else for(var a in e)if(_hasOwnProperty.call(e,a)&&n.call(o,e[a],a,e)==={})return!1}var lifeCycleHook=['appOnLaunch','appOnShow','appOnHide','pageOnShow','pageOnLoad'],miniLifeCycleAPI={};function registerLifeCycleHook(e){Object.assign(miniLifeCycleAPI,e)}function getScene(e,n){if(!isObject(n))return!1;var o=n.meta.scene_prefix;return!(!o||!isString(o))&&('number'==typeof e||'string'==typeof e&&''!==e?e=o+String(e):'\u672a\u53d6\u5230\u503c')}function hookFunc(e,n,o){if(e[n]&&isFunction(o)){var t=e[n];e[n]=function(e){o.call(this,e),t&&isFunction(t)&&t.call(this,e)}}}function hookAppFunc(e){hookFunc(e,'onLaunch',miniLifeCycleAPI.appOnLaunch),hookFunc(e,'onShow',miniLifeCycleAPI.appOnShow),hookFunc(e,'onHide',miniLifeCycleAPI.appOnHide)}function proxyApp(e,n){function o(e){var o=App;App=function(t){try{e&&e(t),t[n.para.name]=n,o.apply(this,arguments)}catch(e){o.apply(this,arguments),global.sensors.log('App:'+e)}}}isObject(n)&&isFunction(n.platform_obj.onAppShow)&&isFunction(n.platform_obj.onAppHide)?(o(),n.platform_obj.onAppShow(function(e){if(!n.para.launched&&isFunction(n.platform_obj.getLaunchOptionsSync)){var o=n.platform_obj.getLaunchOptionsSync()||{};miniLifeCycleAPI.appOnLaunch(o),n.para.launched=!0}miniLifeCycleAPI.appOnShow(e)}),n.platform_obj.onAppHide(function(){miniLifeCycleAPI.appOnHide()})):o(e)}function getPath(e){return e=isString(e)?e.replace(/^\//,''):'\u53d6\u503c\u5f02\u5e38'}function getCurrentPath(e){var n='\u672a\u53d6\u5230',o=getCurrentPage(e);return o&&o.route&&(n=o.route),n}function getCurrentPage(e){var n,o={};if(e)try{o=(n=isFunction(e.platform_obj.getCurrentPages)?e.platform_obj.getCurrentPages():getCurrentPages())[n.length-1]}catch(n){e.log(n)}else console.log('getCurrentPage:\u8bf7\u4f20\u5165 sa \u5bf9\u8c61');return o}function appOnLaunch(e,n){if(isObject(e)){var o={};if(e&&e.path&&(o.$url_path=getPath(e.path)),e&&e.scene){var t=getScene(e.scene,global.sensors);t&&(o.$scene=t,global.sensors.meta.current_scene=t,global.sensors.registerApp({$latest_scene:t}))}else o.$scene='\u672a\u53d6\u5230\u503c';var r=global.sensors._.setUtm(e,o);global.sensors.meta.is_first_launch?(o.$is_first_time=!0,global.sensors._.isEmptyObject(r.pre1)||global.sensors.setOnceProfile(r.pre1)):o.$is_first_time=!1,global.sensors._.isEmptyObject(r.pre2)||global.sensors._.setLatestChannel(r.pre2),o.$url_query=global.sensors._.setQuery(e.query),isObject(n)&&(o=extend(o,n)),global.sensors.para&&global.sensors.para.autoTrack&&global.sensors.para.autoTrack.appLaunch&&global.sensors.track('$MPLaunch',o)}else global.sensors.log('appOnLaunch:\u8bf7\u4f20\u5165\u6b63\u786e\u7684\u53c2\u6570')}function appOnShow(e,n){var o={};global.sensors.meta.mp_show_time=(new Date).getTime(),e&&e.path&&(o.$url_path=getPath(e.path));var t=global.sensors._.setUtm(e,o);if(global.sensors._.isEmptyObject(t.pre2)||global.sensors._.setLatestChannel(t.pre2),o.$url_query=global.sensors._.setQuery(e.query),e&&e.scene){var r=getScene(e.scene,global.sensors);r&&(o.$scene=r,global.sensors.registerApp({$latest_scene:r}))}isObject(n)&&(o=extend(o,n)),global.sensors.para&&global.sensors.para.autoTrack&&global.sensors.para.autoTrack.appShow&&global.sensors.track('$MPShow',o)}function appOnHide(e){var n=(new Date).getTime(),o={};isObject(e)&&(o=extend(o,e)),o.$url_path=getCurrentPath(global.sensors);var t=global.sensors.meta.mp_show_time;t&&n-t>0&&(n-t)/36e5<24&&(o.event_duration=(n-t)/1e3),global.sensors.para&&global.sensors.para.autoTrack&&global.sensors.para.autoTrack.appHide&&global.sensors.track('$MPHide',o)}lifeCycleHook.forEach(function(e){miniLifeCycleAPI[e]=function(){throw new Error(`\u9700\u8981\u5148\u5b9a\u4e49 '${e}' \u624d\u80fd\u4f7f\u7528`)}});var presetEvents={appLaunch:!0,appShow:!0,appHide:!0},AutoTrackApp={name:'AutoTrackApp',init:function(e,n){if(!e)return console.log('\u8bf7\u6b63\u786e\u521d\u59cb\u5316 sensorsdata\uff0c\u624d\u80fd\u4f7f\u7528\u63d2\u4ef6'),!1;global.sensors=e,global.sensors.para.autoTrack=extend(presetEvents,n),AutoTrackApp.lifeCycleAPI(),AutoTrackApp.proxyFrameworkInterface()},lifeCycleAPI:function(){var e={};e.appOnLaunch=appOnLaunch,e.appOnShow=appOnShow,e.appOnHide=appOnHide,registerLifeCycleHook(e)},proxyFrameworkInterface:function(){proxyApp(hookAppFunc,global.sensors)}};export default AutoTrackApp;