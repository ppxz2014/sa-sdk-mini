const forEach=Array.prototype.forEach,slice=Array.prototype.slice,_hasOwnProperty=Object.prototype.hasOwnProperty,_toString=Object.prototype.toString;function extend(e){return each(slice.call(arguments,1),function(o){for(var n in o)void 0!==o[n]&&(e[n]=o[n])}),e}function isObject(e){return null!==e&&'object'==typeof e}function isFunction(e){if(!e)return!1;var o=Object.prototype.toString.call(e);return'[object Function]'==o||'[object AsyncFunction]'==o||'[object GeneratorFunction]'==o}function isString(e){return'[object String]'==_toString.call(e)}function each(e,o,n){if(null==e)return!1;if(forEach&&e.forEach===forEach)e.forEach(o,n);else if(e.length===+e.length){for(var a=0,r=e.length;a<r;a++)if(a in e&&o.call(n,e[a],a,e)==={})return!1}else for(var t in e)if(_hasOwnProperty.call(e,t)&&o.call(n,e[t],t,e)==={})return!1}var global={},lifeCycleHook=['appOnLaunch','appOnShow','appOnHide','pageOnShow','pageOnLoad'],miniLifeCycleAPI={};function registerLifeCycleHook(e){Object.assign(miniLifeCycleAPI,e)}function getScene(e,o){if(!isObject(o))return!1;var n=o.meta.scene_prefix;return!(!n||!isString(n))&&('number'==typeof e||'string'==typeof e&&''!==e?e=n+String(e):'\u672a\u53d6\u5230\u503c')}function hookFunc(e,o,n){if(e[o]&&isFunction(n)){var a=e[o];e[o]=function(e){n.call(this,e),a&&isFunction(a)&&a.call(this,e)}}}function hookAppFunc(e){hookFunc(e,'onLaunch',miniLifeCycleAPI.appOnLaunch),hookFunc(e,'onShow',miniLifeCycleAPI.appOnShow),hookFunc(e,'onHide',miniLifeCycleAPI.appOnHide)}function proxyApp(e,o){function n(e){var n=App;App=function(a){try{e&&e(a),a[o.para.name]=o,n.apply(this,arguments)}catch(e){n.apply(this,arguments),global.sensors.log('App:'+e)}}}isObject(o)&&isFunction(o.platform_obj.onAppShow)&&isFunction(o.platform_obj.onAppHide)?(n(),o.platform_obj.onAppShow(function(e){if(!o.para.launched&&isFunction(o.platform_obj.getLaunchOptionsSync)){var n=o.platform_obj.getLaunchOptionsSync()||{};miniLifeCycleAPI.appOnLaunch(n),o.para.launched=!0}miniLifeCycleAPI.appOnShow(e)}),o.platform_obj.onAppHide(function(){miniLifeCycleAPI.appOnHide()})):n(e)}function getPath(e){return e=isString(e)?e.replace(/^\//,''):'\u53d6\u503c\u5f02\u5e38'}function getCurrentPath(e){var o='\u672a\u53d6\u5230',n=getCurrentPage(e);return n&&n.route&&(o=n.route),o}function getCurrentPage(e){var o,n={};if(e)try{n=(o=isFunction(e.platform_obj.getCurrentPages)?e.platform_obj.getCurrentPages():getCurrentPages())[o.length-1]}catch(o){e.log(o)}else console.log('getCurrentPage:\u8bf7\u4f20\u5165 sa \u5bf9\u8c61');return n}function appOnLaunch(e,o){if(isObject(e)){var n={};if(e&&e.path&&(n.$url_path=getPath(e.path)),e&&e.scene){var a=getScene(e.scene,global.sensors);a&&(n.$scene=a,global.sensors.meta.current_scene=a,global.sensors.registerApp({$latest_scene:a}))}else n.$scene='\u672a\u53d6\u5230\u503c';var r=global.sensors._.setUtm(e,n);global.sensors.meta.is_first_launch?(n.$is_first_time=!0,global.sensors._.isEmptyObject(r.pre1)||global.sensors.setOnceProfile(r.pre1)):n.$is_first_time=!1,global.sensors._.isEmptyObject(r.pre2)||global.sensors._.setLatestChannel(r.pre2),n.$url_query=global.sensors._.setQuery(e.query),isObject(o)&&(n=extend(n,o)),global.sensors.para&&global.sensors.para.autoTrack&&global.sensors.para.autoTrack.appLaunch&&global.sensors.track('$MPLaunch',n)}else global.sensors.log('appOnLaunch:\u8bf7\u4f20\u5165\u6b63\u786e\u7684\u53c2\u6570')}function appOnShow(e,o){var n={};global.sensors.meta.mp_show_time=(new Date).getTime(),e&&e.path&&(n.$url_path=getPath(e.path));var a=global.sensors._.setUtm(e,n);if(global.sensors._.isEmptyObject(a.pre2)||global.sensors._.setLatestChannel(a.pre2),n.$url_query=global.sensors._.setQuery(e.query),e&&e.scene){var r=getScene(e.scene,global.sensors);r&&(n.$scene=r,global.sensors.registerApp({$latest_scene:r}))}isObject(o)&&(n=extend(n,o)),global.sensors.para&&global.sensors.para.autoTrack&&global.sensors.para.autoTrack.appShow&&global.sensors.track('$MPShow',n)}function appOnHide(e){var o=(new Date).getTime(),n={};isObject(e)&&(n=extend(n,e)),n.$url_path=getCurrentPath(global.sensors);var a=global.sensors.meta.mp_show_time;a&&o-a>0&&(o-a)/36e5<24&&(n.event_duration=(o-a)/1e3),global.sensors.para&&global.sensors.para.autoTrack&&global.sensors.para.autoTrack.appHide&&global.sensors.track('$MPHide',n)}lifeCycleHook.forEach(function(e){miniLifeCycleAPI[e]=function(){throw new Error(`\u9700\u8981\u5148\u5b9a\u4e49 '${e}' \u624d\u80fd\u4f7f\u7528`)}});var presetEvents={appLaunch:!0,appShow:!0,appHide:!0},AutoTrackApp={name:'AutoTrackApp',init:function(e,o){if(!e)return console.log('\u8bf7\u6b63\u786e\u521d\u59cb\u5316 sensorsdata\uff0c\u624d\u80fd\u4f7f\u7528\u63d2\u4ef6'),!1;global.sensors=e,global.sensors.para.autoTrack=extend(presetEvents,o),AutoTrackApp.lifeCycleAPI(),AutoTrackApp.proxyFrameworkInterface()},lifeCycleAPI:function(){var e={};e.appOnLaunch=appOnLaunch,e.appOnShow=appOnShow,e.appOnHide=appOnHide,registerLifeCycleHook(e)},proxyFrameworkInterface:function(){proxyApp(hookAppFunc,global.sensors)}},global$1={};function isClick(e){return!!{tap:1,longtap:1,longpress:1}[e]}function createClickData(e){var o={},n={},a=e.currentTarget||{},r=a.dataset||{};return o.$element_id=a.id,o.$element_type=r.type,o.$element_content=r.content,o.$element_name=r.name,isObject(e.event_prop)&&(n=e.event_prop),o.$url_path=getCurrentPath(global$1.sensors),o=extend(o,n)}var ClickTrack={track:function(e){var o=createClickData(e),n=e.currentTarget||{},a=e.target||{},r=e.type,t=global$1.sensors.para;if(isObject(t.framework)&&isObject(t.framework.taro)&&!t.framework.taro.createApp&&a.id&&n.id&&a.id!==n.id)return!1;if(isObject(o)&&r&&isClick(r)){if(t.preset_events&&t.preset_events.collect_element&&!1===t.preset_events.collect_element(arguments[0]))return!1;global$1.sensors.track('$MPClick',o)}}},MP_HOOKS={data:1,onLoad:1,onShow:1,onReady:1,onPullDownRefresh:1,onReachBottom:1,onShareAppMessage:1,onPageScroll:1,onResize:1,onTabItemTap:1,onHide:1,onUnload:1};function clickProxy(e,o){var n=e[o];e[o]=function(){var e=n.apply(this,arguments),o=arguments[0];return isObject(o)&&ClickTrack.track(o),e}}function monitorClick(e){var o=[],n=global$1.sensors.para.autoTrack;if(n&&n.mpClick){o=getMethods(e),tabProxy(e);for(var a=o.length,r=0;r<a;r++)clickProxy(e,o[r])}}function tabProxy(e){var o=e.onTabItemTap;e.onTabItemTap=function(e){o&&o.apply(this,arguments);var n={};e&&(n.$element_content=e.text||''),n.$element_type='tabBar',n.$url_path=e.pagePath?e.pagePath:global$1.sensors._.getCurrentPath(),global$1.sensors.track('$MPClick',n)}}function getMethods(e){var o=[];for(var n in e)'function'!=typeof e[n]||MP_HOOKS[n]||o.push(n);return o}function hookPageFunc(e){hookFunc(e,'onShow',miniLifeCycleAPI.pageOnShow),hookFunc(e,'onLoad',miniLifeCycleAPI.pageOnLoad),hookFunc(e,'onUnload',miniLifeCycleAPI.pageOnUnload),hookFunc(e,'onHide',miniLifeCycleAPI.pageOnHide)}function proxyPage(e,o){var n=Page;Page=function(a){try{a||(a={}),isFunction(e)&&e(a),isFunction(o)&&o(a),n.apply(this,arguments)}catch(e){n.apply(this,arguments),console.log('Page:'+e)}};var a=Component;Component=function(n){try{n||(n={}),n.methods||(n.methods={}),isFunction(e)&&e(n.methods),isFunction(o)&&o(n.methods),a.apply(this,arguments)}catch(e){a.apply(this,arguments),console.log('Component:'+e)}}}var pageLeave=function(){if(global$1.sensors.para.autoTrack&&global$1.sensors.para.autoTrack.pageLeave){var e={},o='';try{o=(e=getCurrentPage(global$1.sensors))?e.route:''}catch(e){global$1.sensors.log(e)}if(global$1.sensors.meta.page_show_time>=0&&''!==o){var n={},a=(Date.now()-global$1.sensors.meta.page_show_time)/1e3;(isNaN(a)||a<0)&&(a=0),n.$url_query=e.sensors_mp_url_query?e.sensors_mp_url_query:'',n.$url_path=o,n.event_duration=a,global$1.sensors.track('$MPPageLeave',n),global$1.sensors.meta.page_show_time=-1}}};function pageOnLoad(e){var o=this;if(global$1.sensors._.isObject(e)){try{o=getCurrentPage(global$1.sensors)}catch(e){global$1.sensors.log('pageOnLoad:'+e)}o.sensors_mp_url_query=global$1.sensors._.setQuery(e),o.sensors_mp_encode_url_query=global$1.sensors._.setQuery(e,!0)}}function pageOnShow(e){global$1.sensors.meta.page_show_time=Date.now();var o={},n='';try{var a=getCurrentPage(global$1.sensors);n=a?a.route:''}catch(e){global$1.sensors.log('pageOnShow:'+e)}a&&(o.$url_query=a.sensors_mp_url_query?a.sensors_mp_url_query:''),o.$url_path=n,o.$referrer=global$1.sensors.meta.sa_referrer,isObject(e)&&(o=extend(o,e)),global$1.sensors.para&&global$1.sensors.para.autoTrack&&global$1.sensors.para.autoTrack.pageShow&&global$1.sensors.track('$MPViewScreen',o),global$1.sensors.meta.sa_referrer=n}function pageOnUnload(){pageLeave()}function pageOnHide(){pageLeave()}var presetEvents$1={pageShow:!0,mpClick:!0,pageLeave:!1},AutoTrackPage={name:'AutoTrackPage',init:function(e,o){if(!e)return console.log('\u8bf7\u6b63\u786e\u521d\u59cb\u5316 sensorsdata\uff0c\u624d\u80fd\u4f7f\u7528\u63d2\u4ef6'),!1;global$1.sensors=e,global$1.sensors.para.autoTrack=extend(presetEvents$1,o),AutoTrackPage.lifeCycleAPI(),AutoTrackPage.proxyFrameworkInterface()},lifeCycleAPI:function(){var e={};e.pageOnShow=pageOnShow,e.pageOnLoad=pageOnLoad,e.pageOnUnload=pageOnUnload,e.pageOnHide=pageOnHide,registerLifeCycleHook(e)},proxyFrameworkInterface:function(){proxyPage(hookPageFunc,monitorClick)}},presetEvents$2={appLaunch:!0,appShow:!0,appHide:!0,pageShow:!0,mpClick:!0},AutoTrack={init:function(e,o){if(!e)return console.log('\u8bf7\u6b63\u786e\u521d\u59cb\u5316 sensorsdata\uff0c\u624d\u80fd\u4f7f\u7528\u63d2\u4ef6'),!1;var n=extend(presetEvents$2,o);e.use(AutoTrackApp,n),e.use(AutoTrackPage,n)}};export default AutoTrack;